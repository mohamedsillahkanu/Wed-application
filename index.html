<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malaria Agent-Based Simulation</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      background: white;
    }
    
    .card-header {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }
    
    .card-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .card-content {
      padding: 20px;
    }
    
    .flex-row {
      display: flex;
      flex-direction: row;
    }
    
    .flex-col {
      display: flex;
      flex-direction: column;
    }
    
    .flex-wrap {
      flex-wrap: wrap;
    }
    
    .w-full {
      width: 100%;
    }
    
    .w-2-3 {
      width: 66.666667%;
    }
    
    .w-1-3 {
      width: 33.333333%;
    }
    
    .mr-4 {
      margin-right: 1rem;
    }
    
    .mt-2 {
      margin-top: 0.5rem;
    }
    
    .mt-4 {
      margin-top: 1rem;
    }
    
    .mb-1 {
      margin-bottom: 0.25rem;
    }
    
    .mb-2 {
      margin-bottom: 0.5rem;
    }
    
    .mb-4 {
      margin-bottom: 1rem;
    }
    
    .p-2 {
      padding: 0.5rem;
    }
    
    .ml-6 {
      margin-left: 1.5rem;
    }
    
    .gap-3 {
      gap: 0.75rem;
    }
    
    .gap-x-4 {
      column-gap: 1rem;
    }
    
    .gap-y-1 {
      row-gap: 0.25rem;
    }
    
    .items-center {
      align-items: center;
    }
    
    button {
      padding: 8px 16px;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-right: 10px;
    }
    
    button.primary {
      background-color: #3b82f6;
      color: white;
      border: none;
    }
    
    button.primary:hover {
      background-color: #2563eb;
    }
    
    button.outline {
      background-color: transparent;
      color: #3b82f6;
      border: 1px solid #3b82f6;
    }
    
    button.outline:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    input[type="range"] {
      width: 100%;
      margin: 8px 0;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .border {
      border: 1px solid #e5e7eb;
    }
    
    .rounded {
      border-radius: 4px;
    }
    
    .rounded-md {
      border-radius: 6px;
    }
    
    .rounded-full {
      border-radius: 9999px;
    }
    
    .border-l-2 {
      border-left-width: 2px;
      padding-left: 10px;
    }
    
    .border-purple-400 {
      border-left-color: #c084fc;
    }
    
    .border-orange-400 {
      border-left-color: #fb923c;
    }
    
    .border-teal-400 {
      border-left-color: #2dd4bf;
    }
    
    .border-blue-400 {
      border-left-color: #60a5fa;
    }
    
    .border-2 {
      border-width: 2px;
    }
    
    .border-purple-500 {
      border-color: #a855f7;
    }
    
    .border-orange-500 {
      border-color: #f97316;
    }
    
    .border-teal-500 {
      border-color: #14b8a6;
    }
    
    .bg-gray-100 {
      background-color: #f3f4f6;
    }
    
    .bg-blue-500 {
      background-color: #3b82f6;
    }
    
    .bg-red-500 {
      background-color: #ef4444;
    }
    
    .bg-green-500 {
      background-color: #22c55e;
    }
    
    .bg-gray-500 {
      background-color: #6b7280;
    }
    
    .bg-blue-200 {
      background-color: #bfdbfe;
    }
    
    .text-sm {
      font-size: 0.875rem;
    }
    
    .text-lg {
      font-size: 1.125rem;
    }
    
    .text-blue-500 {
      color: #3b82f6;
    }
    
    .text-red-500 {
      color: #ef4444;
    }
    
    .text-green-500 {
      color: #22c55e;
    }
    
    .text-gray-500 {
      color: #6b7280;
    }
    
    .text-purple-500 {
      color: #a855f7;
    }
    
    .text-orange-500 {
      color: #f97316;
    }
    
    .text-teal-500 {
      color: #14b8a6;
    }
    
    .text-blue-300 {
      color: #93c5fd;
    }
    
    .font-medium {
      font-weight: 500;
    }
    
    .font-semibold {
      font-weight: 600;
    }
    
    .italic {
      font-style: italic;
    }
    
    .list-disc {
      list-style-type: disc;
      padding-left: 1.5rem;
    }
    
    .w-3 {
      width: 0.75rem;
    }
    
    .h-3 {
      height: 0.75rem;
    }
    
    .w-4 {
      width: 1rem;
    }
    
    .h-4 {
      height: 1rem;
    }
    
    .mr-1 {
      margin-right: 0.25rem;
    }
    
    canvas {
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      max-width: 100%;
    }
    
    @media (max-width: 768px) {
      .flex-row {
        flex-direction: column;
      }
      
      .w-2-3, .w-1-3 {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Malaria Agent-Based Simulation</h2>
    </div>
    <div class="card-content">
      <div class="flex-row">
        <div class="w-2-3 mr-4">
          <canvas id="simulationCanvas" width="600" height="400" class="border rounded w-full"></canvas>
          
          <div class="mt-4 flex-row">
            <button id="startBtn" class="primary">Start</button>
            <button id="pauseBtn" class="outline" disabled>Pause</button>
            <button id="resetBtn" class="outline">Reset</button>
          </div>
          
          <div id="statusIndicators" class="mt-4 flex-row flex-wrap gap-3">
            <!-- Will be populated by JavaScript -->
          </div>
          
          <div id="activeInterventions" class="mt-4 p-2 bg-gray-100 rounded-md text-sm">
            <!-- Will be populated by JavaScript -->
          </div>
          
          <div class="mt-2">
            <p id="dayCounter">Day: 0</p>
          </div>
          
          <div id="chartContainer" class="mt-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <div class="w-1-3 mt-4">
          <h3 class="text-lg font-semibold mb-2">Simulation Parameters</h3>
          
          <div class="mb-4">
            <label for="population" class="mb-1">
              Population: <span id="populationValue">200</span>
            </label>
            <input type="range" id="population" min="10" max="500" step="10" value="200">
          </div>
          
          <div class="mb-4">
            <label for="initialInfected" class="mb-1">
              Initial Infected: <span id="initialInfectedValue">5</span>
            </label>
            <input type="range" id="initialInfected" min="1" max="50" step="1" value="5">
          </div>
          
          <div class="mb-4">
            <label for="transmissionRate" class="mb-1">
              Transmission Rate: <span id="transmissionRateValue">0.40</span>
            </label>
            <input type="range" id="transmissionRate" min="0.1" max="0.9" step="0.05" value="0.4">
          </div>
          
          <div class="mb-4">
            <label for="recoveryRate" class="mb-1">
              Recovery Rate: <span id="recoveryRateValue">0.10</span>
            </label>
            <input type="range" id="recoveryRate" min="0.01" max="0.3" step="0.01" value="0.1">
          </div>
          
          <div class="mb-4">
            <label for="mortalityRate" class="mb-1">
              Mortality Rate: <span id="mortalityRateValue">0.03</span>
            </label>
            <input type="range" id="mortalityRate" min="0" max="0.2" step="0.01" value="0.03">
          </div>
          
          <div class="mb-4">
            <label for="immunityPeriod" class="mb-1">
              Immunity Period (days): <span id="immunityPeriodValue">30</span>
            </label>
            <input type="range" id="immunityPeriod" min="0" max="100" step="5" value="30">
          </div>
          
          <h3 class="text-md font-semibold mt-4 mb-2">Interventions</h3>
          
          <!-- Bed Nets -->
          <div class="mb-3 border-l-2 border-purple-400 pl-2">
            <div class="flex-row items-center mb-2">
              <input type="checkbox" id="useBednets" class="mr-2">
              <label for="useBednets" style="display: inline;">Insecticide-Treated Bed Nets</label>
            </div>
            
            <div id="bednetControls" style="display: none;">
              <div class="ml-6 mb-2">
                <label for="bednetCoverage" class="mb-1 text-sm">
                  Coverage: <span id="bednetCoverageValue">50</span>%
                </label>
                <input type="range" id="bednetCoverage" min="0" max="1" step="0.05" value="0.5">
              </div>
              
              <div class="ml-6 mb-2">
                <label for="bednetEfficacy" class="mb-1 text-sm">
                  Efficacy: <span id="bednetEfficacyValue">70</span>%
                </label>
                <input type="range" id="bednetEfficacy" min="0" max="1" step="0.05" value="0.7">
              </div>
            </div>
          </div>
          
          <!-- Indoor Residual Spraying -->
          <div class="mb-3 border-l-2 border-orange-400 pl-2">
            <div class="flex-row items-center mb-2">
              <input type="checkbox" id="useIRS" class="mr-2">
              <label for="useIRS" style="display: inline;">Indoor Residual Spraying (IRS)</label>
            </div>
            
            <div id="irsControls" style="display: none;">
              <div class="ml-6 mb-2">
                <label for="irsCoverage" class="mb-1 text-sm">
                  Coverage: <span id="irsCoverageValue">30</span>%
                </label>
                <input type="range" id="irsCoverage" min="0" max="1" step="0.05" value="0.3">
              </div>
              
              <div class="ml-6 mb-2">
                <label for="irsEfficacy" class="mb-1 text-sm">
                  Efficacy: <span id="irsEfficacyValue">60</span>%
                </label>
                <input type="range" id="irsEfficacy" min="0" max="1" step="0.05" value="0.6">
              </div>
            </div>
          </div>
          
          <!-- Antimalarial Drugs -->
          <div class="mb-3 border-l-2 border-teal-400 pl-2">
            <div class="flex-row items-center mb-2">
              <input type="checkbox" id="useAntimalarials" class="mr-2">
              <label for="useAntimalarials" style="display: inline;">Antimalarial Medications</label>
            </div>
            
            <div id="antimalarialControls" style="display: none;">
              <div class="ml-6 mb-2">
                <label for="antimalarialCoverage" class="mb-1 text-sm">
                  Coverage: <span id="antimalarialCoverageValue">20</span>%
                </label>
                <input type="range" id="antimalarialCoverage" min="0" max="1" step="0.05" value="0.2">
              </div>
              
              <div class="ml-6 mb-2">
                <label for="antimalarialEfficacy" class="mb-1 text-sm">
                  Efficacy: <span id="antimalarialEfficacyValue">80</span>%
                </label>
                <input type="range" id="antimalarialEfficacy" min="0" max="1" step="0.05" value="0.8">
              </div>
            </div>
          </div>
          
          <!-- Mosquito Control -->
          <div class="mb-3 border-l-2 border-blue-400 pl-2">
            <div class="flex-row items-center mb-2">
              <input type="checkbox" id="useMosquitoControl" class="mr-2">
              <label for="useMosquitoControl" style="display: inline;">Mosquito Control Measures</label>
            </div>
            
            <div id="mosquitoControlControls" style="display: none;">
              <div class="ml-6 mb-2">
                <label for="mosquitoControlIntensity" class="mb-1 text-sm">
                  Intensity: <span id="mosquitoControlIntensityValue">40</span>%
                </label>
                <input type="range" id="mosquitoControlIntensity" min="0" max="0.9" step="0.05" value="0.4">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">About This Simulation</h2>
    </div>
    <div class="card-content">
      <p class="mb-2">
        This is a simplified agent-based model of malaria transmission in a population. 
        Each dot represents a person who can be in one of four states:
      </p>
      
      <ul class="list-disc mb-4">
        <li><span class="text-blue-500 font-medium">Susceptible (Blue)</span>: Can become infected when near infected individuals</li>
        <li><span class="text-red-500 font-medium">Infected (Red)</span>: Has malaria and can spread it to susceptible individuals</li>
        <li><span class="text-green-500 font-medium">Recovered (Green)</span>: Temporarily immune to malaria</li>
        <li><span class="text-gray-500 font-medium">Dead (Gray)</span>: Deceased due to malaria complications</li>
      </ul>
      
      <p class="mb-2">
        The colored circles around individuals represent different interventions:
      </p>
      
      <ul class="list-disc mb-4">
        <li><span class="text-purple-500 font-medium">Purple circles</span>: Insecticide-treated bed nets</li>
        <li><span class="text-orange-500 font-medium">Orange circles</span>: Indoor residual spraying (IRS)</li>
        <li><span class="text-teal-500 font-medium">Teal circles</span>: Antimalarial medications</li>
        <li><span class="text-blue-300 font-medium">Blue background</span>: Mosquito control measures (larvicides, drain clearing, etc.)</li>
      </ul>
      
      <p>
        Adjust the parameters to see how different factors and interventions affect the spread of malaria in the population.
        Try different intervention combinations to find optimal strategies for malaria control and elimination.
      </p>
    </div>
  </div>

  <script>
    // Agent states
    const SUSCEPTIBLE = 'susceptible';
    const INFECTED = 'infected';
    const RECOVERED = 'recovered';
    const DEAD = 'dead';

    // Constants and defaults
    const DEFAULT_POPULATION = 200;
    const DEFAULT_INITIAL_INFECTED = 5;
    const DEFAULT_TRANSMISSION_RATE = 0.4;
    const DEFAULT_RECOVERY_RATE = 0.1;
    const DEFAULT_MORTALITY_RATE = 0.03;
    const DEFAULT_IMMUNITY_PERIOD = 30;
    const DEFAULT_USE_BEDNETS = false;
    const DEFAULT_BEDNET_COVERAGE = 0.5;
    const DEFAULT_BEDNET_EFFICACY = 0.7;
    
    // Simulation state
    let agents = [];
    let day = 0;
    let isRunning = false;
    let animationId = null;
    let statistics = {
      susceptible: 0,
      infected: 0,
      recovered: 0,
      dead: 0,
    };
    let history = [];
    
    // Get DOM elements
    const canvas = document.getElementById('simulationCanvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const dayCounter = document.getElementById('dayCounter');
    const statusIndicators = document.getElementById('statusIndicators');
    const activeInterventions = document.getElementById('activeInterventions');
    const chartContainer = document.getElementById('chartContainer');
    
    // Parameters
    let population = DEFAULT_POPULATION;
    let initialInfected = DEFAULT_INITIAL_INFECTED;
    let transmissionRate = DEFAULT_TRANSMISSION_RATE;
    let recoveryRate = DEFAULT_RECOVERY_RATE;
    let mortalityRate = DEFAULT_MORTALITY_RATE;
    let immunityPeriod = DEFAULT_IMMUNITY_PERIOD;
    
    // Intervention parameters
    let useBednets = DEFAULT_USE_BEDNETS;
    let bednetCoverage = DEFAULT_BEDNET_COVERAGE;
    let bednetEfficacy = DEFAULT_BEDNET_EFFICACY;
    let useIRS = false;
    let irsCoverage = 0.3;
    let irsEfficacy = 0.6;
    let useAntimalarials = false;
    let antimalarialCoverage = 0.2;
    let antimalarialEfficacy = 0.8;
    let useMosquitoControl = false;
    let mosquitoControlIntensity = 0.4;
    
    // Initialize parameter controls
    document.getElementById('population').addEventListener('input', function() {
      population = parseInt(this.value);
      document.getElementById('populationValue').textContent = population;
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('initialInfected').addEventListener('input', function() {
      initialInfected = parseInt(this.value);
      document.getElementById('initialInfectedValue').textContent = initialInfected;
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('transmissionRate').addEventListener('input', function() {
      transmissionRate = parseFloat(this.value);
      document.getElementById('transmissionRateValue').textContent = transmissionRate.toFixed(2);
    });
    
    document.getElementById('recoveryRate').addEventListener('input', function() {
      recoveryRate = parseFloat(this.value);
      document.getElementById('recoveryRateValue').textContent = recoveryRate.toFixed(2);
    });
    
    document.getElementById('mortalityRate').addEventListener('input', function() {
      mortalityRate = parseFloat(this.value);
      document.getElementById('mortalityRateValue').textContent = mortalityRate.toFixed(2);
    });
    
    document.getElementById('immunityPeriod').addEventListener('input', function() {
      immunityPeriod = parseInt(this.value);
      document.getElementById('immunityPeriodValue').textContent = immunityPeriod;
    });
    
    // Bed nets controls
    document.getElementById('useBednets').addEventListener('change', function() {
      useBednets = this.checked;
      document.getElementById('bednetControls').style.display = useBednets ? 'block' : 'none';
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('bednetCoverage').addEventListener('input', function() {
      bednetCoverage = parseFloat(this.value);
      document.getElementById('bednetCoverageValue').textContent = Math.round(bednetCoverage * 100);
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('bednetEfficacy').addEventListener('input', function() {
      bednetEfficacy = parseFloat(this.value);
      document.getElementById('bednetEfficacyValue').textContent = Math.round(bednetEfficacy * 100);
    });
    
    // IRS controls
    document.getElementById('useIRS').addEventListener('change', function() {
      useIRS = this.checked;
      document.getElementById('irsControls').style.display = useIRS ? 'block' : 'none';
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('irsCoverage').addEventListener('input', function() {
      irsCoverage = parseFloat(this.value);
      document.getElementById('irsCoverageValue').textContent = Math.round(irsCoverage * 100);
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('irsEfficacy').addEventListener('input', function() {
      irsEfficacy = parseFloat(this.value);
      document.getElementById('irsEfficacyValue').textContent = Math.round(irsEfficacy * 100);
    });
    
    // Antimalarial controls
    document.getElementById('useAntimalarials').addEventListener('change', function() {
      useAntimalarials = this.checked;
      document.getElementById('antimalarialControls').style.display = useAntimalarials ? 'block' : 'none';
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('antimalarialCoverage').addEventListener('input', function() {
      antimalarialCoverage = parseFloat(this.value);
      document.getElementById('antimalarialCoverageValue').textContent = Math.round(antimalarialCoverage * 100);
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('antimalarialEfficacy').addEventListener('input', function() {
      antimalarialEfficacy = parseFloat(this.value);
      document.getElementById('antimalarialEfficacyValue').textContent = Math.round(antimalarialEfficacy * 100);
    });
    
    // Mosquito control controls
    document.getElementById('useMosquitoControl').addEventListener('change', function() {
      useMosquitoControl = this.checked;
      document.getElementById('mosquitoControlControls').style.display = useMosquitoControl ? 'block' : 'none';
      if (!isRunning) {
        initializeAgents();
      }
    });
    
    document.getElementById('mosquitoControlIntensity').addEventListener('input', function() {
      mosquitoControlIntensity = parseFloat(this.value);
      document.getElementById('mosquitoControlIntensityValue').textContent = Math.round(mosquitoControlIntensity * 100);
    });
    
    // Button event listeners
    startBtn.addEventListener('click', startSimulation);
    pauseBtn.addEventListener('click', stopSimulation);
    resetBtn.addEventListener('click', resetSimulation);
    
    // Initialize agents
    function initializeAgents() {
      agents = [];
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      
      // Create random agents
      for (let i = 0; i < population; i++) {
        // Assign interventions to agents based on coverage
        const hasBednet = useBednets && Math.random() < bednetCoverage;
        const hasIRS = useIRS && Math.random() < irsCoverage;
        const hasAntimalarials = useAntimalarials && Math.random() < antimalarialCoverage;
        
        agents.push({
          id: i,
          x: Math.random() * canvasWidth,
          y: Math.random() * canvasHeight,
          dx: (Math.random() - 0.5) * 2,
          dy: (Math.random() - 0.5) * 2,
          state: i < initialInfected ? INFECTED : SUSCEPTIBLE,
          daysInfected: i < initialInfected ? 1 : 0,
          daysImmune: 0,
          hasBednet: hasBednet,
          hasIRS: hasIRS,
          hasAntimalarials: hasAntimalarials,
        });
      }
      
      day = 0;
      history = [];
      updateStatistics();
      renderCanvas();
      updateDayCounter();
      updateInterventionsDisplay();
    }
    
    // Update agent positions and states
    function updateAgents() {
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;
      
      // Update positions
      agents.forEach(agent => {
        // Skip movement for dead agents
        if (agent.state === DEAD) {
          return;
        }
        
        // Move agent
        let x = agent.x + agent.dx;
        let y = agent.y + agent.dy;
        
        // Bounce off walls
        if (x < 0 || x > canvasWidth) {
          x = Math.max(0, Math.min(x, canvasWidth));
          agent.dx *= -1;
        }
        if (y < 0 || y > canvasHeight) {
          y = Math.max(0, Math.min(y, canvasHeight));
          agent.dy *= -1;
        }
        
        // Update position
        agent.x = x;
        agent.y = y;
      });
      
      processAgentStates();
      
      day++;
      updateStatistics();
      updateDayCounter();
    }
    
    // Process agent state transitions
    function processAgentStates() {
      // First pass: Check for new infections from infected to susceptible
      const infectedAgents = agents.filter(a => a.state === INFECTED);
      
      // Calculate current mosquito population based on mosquito control
      let mosquitoMultiplier = 1.0;
      if (useMosquitoControl) {
        mosquitoMultiplier = 1.0 - mosquitoControlIntensity;
      }
      
      agents.forEach((agent, idx) => {
        if (agent.state === SUSCEPTIBLE) {
          // Check for infections from nearby infected agents
          for (const infectedAgent of infectedAgents) {
            const distance = Math.sqrt(
              Math.pow(agent.x - infectedAgent.x, 2) + 
              Math.pow(agent.y - infectedAgent.y, 2)
            );
            
            // Infection occurs within proximity, with reduced chance if interventions are used
            if (distance < 15) {
              // Base infection chance affected by mosquito population
              let infectionChance = transmissionRate * mosquitoMultiplier;
              
              // Apply intervention effects (multiplicative protection)
              // Bed nets reduce biting rate
              if (agent.hasBednet) {
                infectionChance *= (1 - bednetEfficacy);
              }
              
              // Indoor residual spraying kills mosquitoes in homes
              if (agent.hasIRS) {
                infectionChance *= (1 - irsEfficacy);
              }
              
              // Antimalarials provide prophylactic protection
              if (agent.hasAntimalarials) {
                infectionChance *= (1 - antimalarialEfficacy);
              }
              
              if (Math.random() < infectionChance) {
                agent.state = INFECTED;
                agent.daysInfected = 1;
                break; // Once infected, no need to check other infected agents
              }
            }
          }
        } else if (agent.state === INFECTED) {
          agent.daysInfected++;
          
          // Modify recovery rate if agent has antimalarials (treatment effect)
          let agentRecoveryRate = recoveryRate;
          if (agent.hasAntimalarials) {
            // Antimalarials improve recovery rate
            agentRecoveryRate = recoveryRate * (1 + antimalarialEfficacy);
          }
          
          // Modify mortality rate if agent has antimalarials (reduced complications)
          let agentMortalityRate = mortalityRate;
          if (agent.hasAntimalarials) {
            // Antimalarials reduce mortality risk
            agentMortalityRate = mortalityRate * (1 - antimalarialEfficacy);
          }
          
          // Recovery or death check
          if (Math.random() < agentRecoveryRate) {
            agent.state = RECOVERED;
            agent.daysInfected = 0;
            agent.daysImmune = 1;
          } else if (Math.random() < agentMortalityRate) {
            agent.state = DEAD;
            agent.daysInfected = 0;
          }
        } else if (agent.state === RECOVERED) {
          agent.daysImmune++;
          
          // End of immunity period
          if (agent.daysImmune > immunityPeriod) {
            agent.state = SUSCEPTIBLE;
            agent.daysImmune = 0;
          }
        }
