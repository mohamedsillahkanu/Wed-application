import React, { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Slider } from '@/components/ui/slider';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import _ from 'lodash';

// Agent states
const SUSCEPTIBLE = 'susceptible';
const INFECTED = 'infected';
const RECOVERED = 'recovered';
const DEAD = 'dead';

// Constants and defaults
const DEFAULT_POPULATION = 200;
const DEFAULT_INITIAL_INFECTED = 5;
const DEFAULT_TRANSMISSION_RATE = 0.4;
const DEFAULT_RECOVERY_RATE = 0.1;
const DEFAULT_MORTALITY_RATE = 0.03;
const DEFAULT_IMMUNITY_PERIOD = 30;
const DEFAULT_USE_BEDNETS = false;
const DEFAULT_BEDNET_COVERAGE = 0.5;
const DEFAULT_BEDNET_EFFICACY = 0.7;

const MalariaSimulation = () => {
  // Canvas and animation references
  const canvasRef = useRef(null);
  const animationRef = useRef(null);
  
  // Simulation parameters
  const [population, setPopulation] = useState(DEFAULT_POPULATION);
  const [initialInfected, setInitialInfected] = useState(DEFAULT_INITIAL_INFECTED);
  const [transmissionRate, setTransmissionRate] = useState(DEFAULT_TRANSMISSION_RATE);
  const [recoveryRate, setRecoveryRate] = useState(DEFAULT_RECOVERY_RATE);
  const [mortalityRate, setMortalityRate] = useState(DEFAULT_MORTALITY_RATE);
  const [immunityPeriod, setImmunityPeriod] = useState(DEFAULT_IMMUNITY_PERIOD);
  const [useBednets, setUseBednets] = useState(DEFAULT_USE_BEDNETS);
  const [bednetCoverage, setBednetCoverage] = useState(DEFAULT_BEDNET_COVERAGE);
  const [bednetEfficacy, setBednetEfficacy] = useState(DEFAULT_BEDNET_EFFICACY);
  
  // Simulation state
  const [agents, setAgents] = useState([]);
  const [day, setDay] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [statistics, setStatistics] = useState({
    susceptible: 0,
    infected: 0,
    recovered: 0,
    dead: 0,
  });
  const [history, setHistory] = useState([]);
  
  // Initialize agents
  const initializeAgents = () => {
    const newAgents = [];
    const canvasWidth = canvasRef.current.width;
    const canvasHeight = canvasRef.current.height;
    
    // Create random agents
    for (let i = 0; i < population; i++) {
      const hasBednet = useBednets && Math.random() < bednetCoverage;
      
      newAgents.push({
        id: i,
        x: Math.random() * canvasWidth,
        y: Math.random() * canvasHeight,
        dx: (Math.random() - 0.5) * 2,
        dy: (Math.random() - 0.5) * 2,
        state: i < initialInfected ? INFECTED : SUSCEPTIBLE,
        daysInfected: i < initialInfected ? 1 : 0,
        daysImmune: 0,
        hasBednet: hasBednet,
      });
    }
    
    setAgents(newAgents);
    setDay(0);
    updateStatistics(newAgents);
    setHistory([]);
  };
  
  // Update agent positions and states
  const updateAgents = () => {
    const canvasWidth = canvasRef.current.width;
    const canvasHeight = canvasRef.current.height;
    
    const updatedAgents = agents.map(agent => {
      // Skip movement for dead agents
      if (agent.state === DEAD) {
        return agent;
      }
      
      // Move agent
      let x = agent.x + agent.dx;
      let y = agent.y + agent.dy;
      
      // Bounce off walls
      if (x < 0 || x > canvasWidth) {
        x = Math.max(0, Math.min(x, canvasWidth));
        agent.dx *= -1;
      }
      if (y < 0 || y > canvasHeight) {
        y = Math.max(0, Math.min(y, canvasHeight));
        agent.dy *= -1;
      }
      
      // Update position
      agent.x = x;
      agent.y = y;
      
      return agent;
    });
    
    // Process infections, recoveries, etc.
    const processedAgents = processAgentStates(updatedAgents);
    
    setAgents(processedAgents);
    setDay(prevDay => prevDay + 1);
    updateStatistics(processedAgents);
  };
  
  // Process agent state transitions
  const processAgentStates = (agentList) => {
    // First pass: Check for new infections from infected to susceptible
    let updatedAgents = [...agentList];
    
    // Process infections
    const infectedAgents = updatedAgents.filter(a => a.state === INFECTED);
    
    updatedAgents.forEach((agent, idx) => {
      if (agent.state === SUSCEPTIBLE) {
        // Check for infections from nearby infected agents
        for (const infectedAgent of infectedAgents) {
          const distance = Math.sqrt(
            Math.pow(agent.x - infectedAgent.x, 2) + 
            Math.pow(agent.y - infectedAgent.y, 2)
          );
          
          // Infection occurs within proximity, with reduced chance if bednet is used
          if (distance < 15) {
            let infectionChance = transmissionRate;
            
            // Reduce transmission if using bednets
            if (agent.hasBednet) {
              infectionChance *= (1 - bednetEfficacy);
            }
            
            if (Math.random() < infectionChance) {
              updatedAgents[idx] = {
                ...agent,
                state: INFECTED,
                daysInfected: 1
              };
              break; // Once infected, no need to check other infected agents
            }
          }
        }
      }
    });
    
    // Second pass: Process infected agents (recovery or death)
    updatedAgents = updatedAgents.map(agent => {
      if (agent.state === INFECTED) {
        agent.daysInfected++;
        
        // Recovery or death check
        if (Math.random() < recoveryRate) {
          return {
            ...agent,
            state: RECOVERED,
            daysInfected: 0,
            daysImmune: 1,
          };
        } else if (Math.random() < mortalityRate) {
          return {
            ...agent,
            state: DEAD,
            daysInfected: 0,
          };
        }
      } else if (agent.state === RECOVERED) {
        agent.daysImmune++;
        
        // End of immunity period
        if (agent.daysImmune > immunityPeriod) {
          return {
            ...agent,
            state: SUSCEPTIBLE,
            daysImmune: 0,
          };
        }
      }
      
      return agent;
    });
    
    return updatedAgents;
  };
  
  // Update statistics
  const updateStatistics = (agentList) => {
    const stats = {
      susceptible: agentList.filter(a => a.state === SUSCEPTIBLE).length,
      infected: agentList.filter(a => a.state === INFECTED).length,
      recovered: agentList.filter(a => a.state === RECOVERED).length,
      dead: agentList.filter(a => a.state === DEAD).length,
    };
    
    setStatistics(stats);
    setHistory(prev => [...prev, { day: day, ...stats }]);
  };
  
  // Animation frame handler
  const animate = () => {
    if (!isRunning) return;
    
    updateAgents();
    renderCanvas();
    
    // Continue animation if there are still infected agents
    if (statistics.infected > 0) {
      animationRef.current = requestAnimationFrame(animate);
    } else {
      setIsRunning(false);
    }
  };
  
  // Render agents on canvas
  const renderCanvas = () => {
    if (!canvasRef.current) return;
    
    const ctx = canvasRef.current.getContext('2d');
    const width = canvasRef.current.width;
    const height = canvasRef.current.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Draw agents
    agents.forEach(agent => {
      // Set color based on state
      let color = '#333';
      switch (agent.state) {
        case SUSCEPTIBLE:
          color = '#3498db'; // Blue
          break;
        case INFECTED:
          color = '#e74c3c'; // Red
          break;
        case RECOVERED:
          color = '#2ecc71'; // Green
          break;
        case DEAD:
          color = '#7f8c8d'; // Gray
          break;
      }
      
      ctx.fillStyle = color;
      
      // Draw agent
      ctx.beginPath();
      ctx.arc(agent.x, agent.y, 5, 0, Math.PI * 2);
      ctx.fill();
      
      // Draw bednet indicator
      if (agent.hasBednet && agent.state !== DEAD) {
        ctx.strokeStyle = '#9b59b6'; // Purple for bednets
        ctx.beginPath();
        ctx.arc(agent.x, agent.y, 8, 0, Math.PI * 2);
        ctx.stroke();
      }
    });
  };
  
  // Start simulation
  const startSimulation = () => {
    if (isRunning) return;
    
    setIsRunning(true);
    animationRef.current = requestAnimationFrame(animate);
  };
  
  // Stop simulation
  const stopSimulation = () => {
    setIsRunning(false);
    cancelAnimationFrame(animationRef.current);
  };
  
  // Reset simulation
  const resetSimulation = () => {
    stopSimulation();
    initializeAgents();
  };
  
  // Initialize on mount
  useEffect(() => {
    if (canvasRef.current) {
      // Adjust canvas size
      canvasRef.current.width = 600;
      canvasRef.current.height = 400;
      
      initializeAgents();
    }
    
    // Cleanup on unmount
    return () => {
      cancelAnimationFrame(animationRef.current);
    };
  }, []);
  
  // Reinitialize when parameters change
  useEffect(() => {
    if (isRunning) {
      stopSimulation();
    }
    
    if (canvasRef.current) {
      initializeAgents();
    }
  }, [
    population,
    initialInfected,
    useBednets,
    bednetCoverage,
    bednetEfficacy
  ]);
  
  // Draw initial state
  useEffect(() => {
    renderCanvas();
  }, [agents]);
  
  // Draw chart
  const renderChart = () => {
    if (history.length === 0) return null;
    
    const chartHeight = 150;
    const chartWidth = 600;
    const maxValue = Math.max(
      population,
      ...history.map(h => Math.max(h.susceptible, h.infected, h.recovered))
    );
    
    // Scale points to chart size
    const scaleY = (value) => chartHeight - (value / maxValue) * chartHeight;
    const scaleX = (index) => (index / (history.length - 1 || 1)) * chartWidth;
    
    // Create SVG paths
    const createPath = (dataKey, color) => {
      if (history.length === 0) return null;
      
      const points = history.map((h, i) => `${scaleX(i)},${scaleY(h[dataKey])}`).join(' ');
      
      return (
        <polyline
          points={points}
          fill="none"
          stroke={color}
          strokeWidth="2"
        />
      );
    };
    
    return (
      <div className="mt-4">
        <h3 className="text-lg font-semibold mb-2">Disease Progression</h3>
        <svg width={chartWidth} height={chartHeight} style={{ border: '1px solid #ccc' }}>
          {createPath('susceptible', '#3498db')}
          {createPath('infected', '#e74c3c')}
          {createPath('recovered', '#2ecc71')}
          {createPath('dead', '#7f8c8d')}
          
          {/* X-axis */}
          <line x1="0" y1={chartHeight} x2={chartWidth} y2={chartHeight} stroke="#333" strokeWidth="1" />
          
          {/* Y-axis */}
          <line x1="0" y1="0" x2="0" y2={chartHeight} stroke="#333" strokeWidth="1" />
        </svg>
        
        <div className="flex mt-2 space-x-4">
          <div className="flex items-center">
            <div className="w-3 h-3 bg-blue-500 mr-1"></div>
            <span className="text-sm">Susceptible</span>
          </div>
          <div className="flex items-center">
            <div className="w-3 h-3 bg-red-500 mr-1"></div>
            <span className="text-sm">Infected</span>
          </div>
          <div className="flex items-center">
            <div className="w-3 h-3 bg-green-500 mr-1"></div>
            <span className="text-sm">Recovered</span>
          </div>
          <div className="flex items-center">
            <div className="w-3 h-3 bg-gray-500 mr-1"></div>
            <span className="text-sm">Dead</span>
          </div>
        </div>
      </div>
    );
  };
  
  return (
    <div className="mx-auto max-w-4xl p-4">
      <Card className="mb-6">
        <CardHeader>
          <CardTitle>Malaria Agent-Based Simulation</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex flex-col md:flex-row">
            <div className="w-full md:w-2/3 pr-0 md:pr-4">
              <canvas
                ref={canvasRef}
                className="border border-gray-300 rounded w-full"
                style={{ maxWidth: '600px', height: '400px' }}
              />
              
              <div className="mt-4 flex space-x-2">
                <Button 
                  onClick={startSimulation} 
                  disabled={isRunning || statistics.infected === 0}
                >
                  Start
                </Button>
                <Button 
                  onClick={stopSimulation} 
                  disabled={!isRunning}
                  variant="outline"
                >
                  Pause
                </Button>
                <Button 
                  onClick={resetSimulation}
                  variant="outline"
                >
                  Reset
                </Button>
              </div>
              
              <div className="mt-4 flex flex-wrap gap-3">
                <div className="flex items-center mr-4">
                  <div className="w-4 h-4 bg-blue-500 mr-1 rounded-full"></div>
                  <span>Susceptible: {statistics.susceptible}</span>
                </div>
                <div className="flex items-center mr-4">
                  <div className="w-4 h-4 bg-red-500 mr-1 rounded-full"></div>
                  <span>Infected: {statistics.infected}</span>
                </div>
                <div className="flex items-center mr-4">
                  <div className="w-4 h-4 bg-green-500 mr-1 rounded-full"></div>
                  <span>Recovered: {statistics.recovered}</span>
                </div>
                <div className="flex items-center">
                  <div className="w-4 h-4 bg-gray-500 mr-1 rounded-full"></div>
                  <span>Dead: {statistics.dead}</span>
                </div>
              </div>
              
              <div className="mt-2">
                <p>Day: {day}</p>
              </div>
              
              {renderChart()}
            </div>
            
            <div className="w-full md:w-1/3 mt-4 md:mt-0">
              <h3 className="text-lg font-semibold mb-2">Simulation Parameters</h3>
              
              <div className="mb-4">
                <Label htmlFor="population" className="block mb-1">
                  Population: {population}
                </Label>
                <Slider
                  id="population"
                  min={10}
                  max={500}
                  step={10}
                  value={[population]}
                  onValueChange={(value) => setPopulation(value[0])}
                  disabled={isRunning}
                />
              </div>
              
              <div className="mb-4">
                <Label htmlFor="initialInfected" className="block mb-1">
                  Initial Infected: {initialInfected}
                </Label>
                <Slider
                  id="initialInfected"
                  min={1}
                  max={Math.min(50, population)}
                  step={1}
                  value={[initialInfected]}
                  onValueChange={(value) => setInitialInfected(value[0])}
                  disabled={isRunning}
                />
              </div>
              
              <div className="mb-4">
                <Label htmlFor="transmissionRate" className="block mb-1">
                  Transmission Rate: {transmissionRate.toFixed(2)}
                </Label>
                <Slider
                  id="transmissionRate"
                  min={0.1}
                  max={0.9}
                  step={0.05}
                  value={[transmissionRate]}
                  onValueChange={(value) => setTransmissionRate(value[0])}
                />
              </div>
              
              <div className="mb-4">
                <Label htmlFor="recoveryRate" className="block mb-1">
                  Recovery Rate: {recoveryRate.toFixed(2)}
                </Label>
                <Slider
                  id="recoveryRate"
                  min={0.01}
                  max={0.3}
                  step={0.01}
                  value={[recoveryRate]}
                  onValueChange={(value) => setRecoveryRate(value[0])}
                />
              </div>
              
              <div className="mb-4">
                <Label htmlFor="mortalityRate" className="block mb-1">
                  Mortality Rate: {mortalityRate.toFixed(2)}
                </Label>
                <Slider
                  id="mortalityRate"
                  min={0}
                  max={0.2}
                  step={0.01}
                  value={[mortalityRate]}
                  onValueChange={(value) => setMortalityRate(value[0])}
                />
              </div>
              
              <div className="mb-4">
                <Label htmlFor="immunityPeriod" className="block mb-1">
                  Immunity Period (days): {immunityPeriod}
                </Label>
                <Slider
                  id="immunityPeriod"
                  min={0}
                  max={100}
                  step={5}
                  value={[immunityPeriod]}
                  onValueChange={(value) => setImmunityPeriod(value[0])}
                />
              </div>
              
              <div className="mb-4">
                <div className="flex items-center mb-2">
                  <input
                    type="checkbox"
                    id="useBednets"
                    checked={useBednets}
                    onChange={(e) => setUseBednets(e.target.checked)}
                    disabled={isRunning}
                    className="mr-2"
                  />
                  <Label htmlFor="useBednets">Use Bed Nets</Label>
                </div>
                
                {useBednets && (
                  <>
                    <div className="ml-6 mb-4">
                      <Label htmlFor="bednetCoverage" className="block mb-1">
                        Bed Net Coverage: {(bednetCoverage * 100).toFixed(0)}%
                      </Label>
                      <Slider
                        id="bednetCoverage"
                        min={0}
                        max={1}
                        step={0.05}
                        value={[bednetCoverage]}
                        onValueChange={(value) => setBednetCoverage(value[0])}
                        disabled={isRunning}
                      />
                    </div>
                    
                    <div className="ml-6 mb-4">
                      <Label htmlFor="bednetEfficacy" className="block mb-1">
                        Bed Net Efficacy: {(bednetEfficacy * 100).toFixed(0)}%
                      </Label>
                      <Slider
                        id="bednetEfficacy"
                        min={0}
                        max={1}
                        step={0.05}
                        value={[bednetEfficacy]}
                        onValueChange={(value) => setBednetEfficacy(value[0])}
                      />
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
      
      <Card>
        <CardHeader>
          <CardTitle>About This Simulation</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="mb-2">
            This is a simplified agent-based model of malaria transmission in a population. 
            Each dot represents a person who can be in one of four states:
          </p>
          
          <ul className="list-disc pl-6 mb-4">
            <li><span className="text-blue-500 font-medium">Susceptible (Blue)</span>: Can become infected when near infected individuals</li>
            <li><span className="text-red-500 font-medium">Infected (Red)</span>: Has malaria and can spread it to susceptible individuals</li>
            <li><span className="text-green-500 font-medium">Recovered (Green)</span>: Temporarily immune to malaria</li>
            <li><span className="text-gray-500 font-medium">Dead (Gray)</span>: Deceased due to malaria complications</li>
          </ul>
          
          <p className="mb-2">
            The purple circles around some individuals represent bed nets, which reduce the chance of malaria transmission.
          </p>
          
          <p>
            Adjust the parameters to see how different factors affect the spread of malaria in the population.
            Try scenarios with different intervention strategies by changing the bed net coverage and efficacy.
          </p>
        </CardContent>
      </Card>
    </div>
  );
};

export default MalariaSimulation;
